version: 2.1

orbs:
  win: circleci/windows@5.0.0

jobs:
  unit-tests:
    executor:
      name: win/server-2022
      shell: bash.exe
    working_directory: C:\Users\circleci\project\PrimeService.Tests
    steps:
      - checkout:
          path: C:\Users\circleci\project
      - restore_cache:
          keys:
            - dotnet-packages-v1-{{ checksum "PrimeService.Tests.csproj" }}
      - run:
          name: Generate list of tests
          command: |
            # This generates a list of tests and saves to a file
            dotnet test -t --nologo > list_of_tests.txt
            # This cuts out the crud and formats the list of tests
            sed -i '1,/available:/d;s/^[ \t]*//;s/$/ |/' list_of_tests.txt
      - run:
          name: Run tests and save output
          command: |
            # Struggling here to apply the list of tests in the correct format
            TEST=$(cat list_of_tests.txt | circleci tests split )
            dotnet test --filter $TEST --logger:"trx;LogFilePrefix=testResults"
      - save_cache:
          paths: 
            - ./
          key: dotnet-packages-v1-{{ checksum "PrimeService.Tests.csproj" }}
      - run:
          name: install trx2junit and convert test results to junit
          command: |
            dotnet tool install -g trx2junit
            cd $TEST_PATH
            /c/Users/circleci/.dotnet/tools/trx2junit.exe TestResults/*
      - store_test_results:
          path: $TEST_PATH/TestResults
      - store_artifacts:
          path: $TEST_PATH/TestResults
 
workflows:
  integration-tests:
    jobs:
      - unit-tests